# scope = country
culture_enslaved_percent_country_cache_update = {
	save_temporary_scope_as = country
	# Initialize per culture counters
	every_scope_culture = {
		set_variable = {
			name = pop_total
			value = 0
		}
		set_variable = {
			name = pop_slaves
			value = 0
		}
	}
	# Count the pops
	if = {
		limit = {
			NOT = { scope:country = { has_law = law_type:law_slavery_banned } }
		}
		every_scope_pop = {
			culture = {
				change_variable = {
					name = pop_total
					add = prev.total_size
				}
				if = {
					limit = {
						prev = { is_pop_type = slaves }
					}
					change_variable = {
						name = pop_slaves
						add = prev.total_size
					}
				}
			}
		}
	}
	# Save the percents
	every_scope_culture = {
		save_temporary_scope_as = culture
		scope:country = {
			save_temporary_scope_value_as = {
				name = percent_enslaved
				value = {
					value = scope:culture.var:pop_slaves
					divide = {
						value = scope:culture.var:pop_total
						min = 1
					}
				}
			}
			add_to_scope_value_map = {
				name = culture_enslaved_percent_cache
				key = scope:culture
				value = scope:percent_enslaved
			}
		}
		# Cleanup working variables
		remove_variable = pop_total
		remove_variable = pop_slaves
	}
}