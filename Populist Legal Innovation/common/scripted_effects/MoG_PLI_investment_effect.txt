# Country scope unless called specifically in JE Scope.
MoG_PLI_do_investment_setup_effect = {
	set_local_variable = {
		name = mog_pli_investment_bar_start_value
		value = mog_pli_investment_target
	}
	je:je_mog_pli_investment = {
		set_bar_progress = {
			value = local_var:mog_pli_investment_bar_start_value
			name = mog_pli_investment_tracking_bar
		}
	}
}

MoG_PLI_do_investment_stuff_effect = {
	if = { # Create variables if not set already
		limit = {
			NOT = {
				has_variable = mog_pli_investment_current_prev
			}
		}
		MoG_PLI_set_investment_variables_effect = yes
	}
	
	## Different pop types have different absolute contribution amounts, so each one needs their own calculation (unfortunately).
	## These are ordered from highest wage multiplier to lowest wage multiplier, and alphabetical within that, just to have some sort of ordering...
	# Calculate adjustment for ARISTOCRAT investment contributions
	calculate_pop_investment_adjustment = { POP = aristocrats }

	# Calculate adjustment for CAPITALIST investment contributions
	calculate_pop_investment_adjustment = { POP = capitalists }
	
	# Calculate adjustment for OFFICER investment contributions
	calculate_pop_investment_adjustment = { POP = officers }
	
	# Calculate adjustment for ACADEMIC investment contributions
	calculate_pop_investment_adjustment = { POP = academics }
	
	# Calculate adjustment for BUREAUCRAT investment contributions
	calculate_pop_investment_adjustment = { POP = bureaucrats }
	
	# Calculate adjustment for CLERGYMEN investment contributions
	calculate_pop_investment_adjustment = { POP = clergymen }
	
	# Calculate adjustment for ENGINEER investment contributions
	calculate_pop_investment_adjustment = { POP = engineers }
	
	# Calculate adjustment for SHOPKEEPER investment contributions
	calculate_pop_investment_adjustment = { POP = shopkeepers }
	
	# Calculate adjustment for FARMER investment contributions
	calculate_pop_investment_adjustment = { POP = farmers }
	
	# Calculate adjustment for CLERK investment contributions
	calculate_pop_investment_adjustment = { POP = clerks }
	
	# Calculate adjustment for MACHINIST investment contributions
	calculate_pop_investment_adjustment = { POP = machinists }
	
	# Calculate adjustment for SERVICEMEN/SOLDIER investment contributions
	calculate_pop_investment_adjustment = { POP = soldiers }
	
	# Calculate adjustment for LABORER investment contributions
	calculate_pop_investment_adjustment = { POP = laborers }
	
	set_variable = {									# At the end of the process, set the current target as the previous to use for next time.
		name = mog_pli_investment_current_prev			# Used in mog_pli_<pop>_contribution_base_sv
		value = var:mog_pli_investment_current_value	# Note: number value between 0-100 & represents limiting % multiplier (from JE)
	}
}

MoG_PLI_set_investment_variables_effect = { # Create variables if not set already
	if = {
		limit = {
			NOT = { has_variable = mog_pli_investment_current_prev }
		}
		set_variable = {
			name  = mog_pli_investment_current_prev
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_aristocrats_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_aristocrats_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_capitalists_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_capitalists_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_officers_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_officers_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_academics_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_academics_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_bureaucrats_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_bureaucrats_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_clergymen_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_clergymen_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_engineers_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_engineers_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_shopkeepers_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_shopkeepers_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_farmers_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_farmers_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_clerks_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_clerks_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_machinists_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_machinists_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_soldiers_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_soldiers_contribution_adjustment
			value = 0
		}
	}
	if = {
		limit = { NOT = { has_variable = mog_pli_laborers_contribution_adjustment } }
		set_variable = {
			name  = mog_pli_laborers_contribution_adjustment
			value = 0
		}
	}
}

calculate_pop_investment_adjustment = {
	# Parameter POP
	# Calculate adjustment for $POP$ investment contributions
	set_variable = {
		name = mog_pli_$POP$_contribution_adjustment	# This a positive number that represents the magnitude of the negative adjustment modifier.
		value = {										# Contributions are 0-1 so remember we're ultimately getting a % portion of a "percent" value.
			add = {														# Calculate what the default modifier value would be right now - 
				add = mog_pli_$POP$_contribution_base_sv					# - i.e. the total unadjusted modifier based on previous month.
				add = {															# Account for if base sources of the modifier have changed since previously.
					add = modifier:state_$POP$_investment_pool_contribution_add
					subtract = {
						add = mog_pli_$POP$_contribution_base_sv				# base - adjustment = actual modifier value
						subtract = var:mog_pli_$POP$_contribution_adjustment	# if sources have increased -> result +ve, else -ve if decreased
					}															# -> tracks underlying changes correctly and adapts to them
				}
			}
			multiply = {								# ^So now that we have the current base value from above, multiply by investment % from the JE.
				value = {
					add = 100											# investment_current_value is actually the limiting proportion
					subtract = var:mog_pli_investment_current_value		# 100-current gets the proportion for the negative penalty
					divide = 100										# Convert to %
				}
			}
		}												# Now we have the actual magnitude of the negative modifier to be additively applied.
	}
	scope:journal_entry = {
		if = { 				# Remove outdated modifier.
			limit = { has_modifier = je_mog_pli_$POP$_investment_modifier }
			remove_modifier = je_mog_pli_$POP$_investment_modifier
		}
		add_modifier = {	# Add updated modifier.
			name = je_mog_pli_$POP$_investment_modifier					# (default value: state_$POP$_investment_pool_contribution_add = -1 )
			multiplier = var:mog_pli_$POP$_contribution_adjustment		# some value between 0 & the unadjusted pop investment contribution modifier value
		}
	}
}